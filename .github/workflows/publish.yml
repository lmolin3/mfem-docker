name: Publish images

on:
  push:
    branches: [main]
    paths:
      - 'docker-bake.hcl'
      - 'toolchain/**'
      - 'cuda-base/**'
      - 'cpu-tpls/**'
      - 'cpu-tpls-debug/**'
      - 'gpu-tpls/**'
      - '.github/workflows/publish.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docker-bake.hcl'
      - 'toolchain/**'
      - 'cuda-base/**'
      - 'cpu-tpls/**'
      - 'cpu-tpls-debug/**'
      - 'gpu-tpls/**'
      - '.github/workflows/publish.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  # ── Detect which components changed ─────────────────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      bases: ${{ steps.filter.outputs.bases }}
      cpu:   ${{ steps.filter.outputs.cpu }}
      gpu:   ${{ steps.filter.outputs.gpu }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            bases:
              - 'docker-bake.hcl'
              - 'toolchain/**'
              - 'cuda-base/**'
              - '.github/workflows/publish.yml'
            cpu:
              - 'docker-bake.hcl'
              - 'toolchain/**'
              - 'cpu-tpls/**'
              - 'cpu-tpls-debug/**'
            gpu:
              - 'docker-bake.hcl'
              - 'cuda-base/**'
              - 'gpu-tpls/**'

  # ── Stage 1: foundation layers ──────────────────────────────────────────────
  bases:
    needs: changes
    if: needs.changes.outputs.bases == 'true' || github.event_name == 'workflow_dispatch'
    name: Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        target: [toolchain, cuda-base]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build (and push on main)
        uses: docker/bake-action@v5
        with:
          workdir: .
          targets: ${{ matrix.target }}
          push: ${{ github.event_name != 'pull_request' }}
          set: |
            *.cache-from=type=gha,scope=${{ matrix.target }}
            *.cache-to=type=gha,mode=max,scope=${{ matrix.target }}

  # ── Stage 2: CPU images ─────────────────────────────────────────────────────
  cpu:
    needs: [changes, bases]
    if: |
      (needs.changes.outputs.cpu == 'true' || github.event_name == 'workflow_dispatch') &&
      !failure() && !cancelled()
    name: Build ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [cpu-tpls, cpu-tpls-debug]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build (and push on main)
        uses: docker/bake-action@v5
        with:
          workdir: .
          targets: ${{ matrix.target }}
          push: ${{ github.event_name != 'pull_request' }}
          set: |
            *.cache-from=type=gha,scope=${{ matrix.target }}
            *.cache-to=type=gha,mode=max,scope=${{ matrix.target }}

  # ── Stage 2: GPU images ─────────────────────────────────────────────────────
  gpu:
    needs: [changes, bases]
    if: |
      (needs.changes.outputs.gpu == 'true' || github.event_name == 'workflow_dispatch') &&
      !failure() && !cancelled()
    name: Build gpu-tpls-sm${{ matrix.sm }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sm: ["80", "90", "120"]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build (and push on main)
        uses: docker/bake-action@v5
        with:
          workdir: .
          targets: gpu-tpls-sm${{ matrix.sm }}
          push: ${{ github.event_name != 'pull_request' }}
          set: |
            *.cache-from=type=gha,scope=gpu-tpls-sm${{ matrix.sm }}
            *.cache-to=type=gha,mode=max,scope=gpu-tpls-sm${{ matrix.sm }}

  # ── Stage 3: Cleanup old package versions ───────────────────────────────────
  cleanup:
    needs: [bases, cpu, gpu]
    if: github.event_name != 'pull_request' && !failure() && !cancelled()
    name: Cleanup ${{ matrix.package }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - toolchain
          - cuda-base
          - cpu-tpls
          - cpu-tpls-debug
          - gpu-tpls-sm80
          - gpu-tpls-sm90
          - gpu-tpls-sm120
    steps:
      - name: Delete old versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ matrix.package }}
          package-type: container
          min-versions-to-keep: 1
          delete-only-untagged-versions: false
          token: ${{ secrets.GITHUB_TOKEN }}
